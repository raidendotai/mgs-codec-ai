"use strict";var ue=Object.defineProperty;var Fe=Object.getOwnPropertyDescriptor;var Ve=Object.getOwnPropertyNames;var Qe=Object.prototype.hasOwnProperty;var Se=e=>{throw TypeError(e)};var qe=(e,r)=>{for(var t in r)ue(e,t,{get:r[t],enumerable:!0})},ze=(e,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of Ve(r))!Qe.call(e,i)&&i!==t&&ue(e,i,{get:()=>r[i],enumerable:!(n=Fe(r,i))||n.enumerable});return e};var $e=e=>ze(ue({},"__esModule",{value:!0}),e);var pe=(e,r,t)=>r.has(e)||Se("Cannot "+t);var a=(e,r,t)=>(pe(e,r,"read from private field"),t?t.call(e):r.get(e)),p=(e,r,t)=>r.has(e)?Se("Cannot add the same private member more than once"):r instanceof WeakSet?r.add(e):r.set(e,t),d=(e,r,t,n)=>(pe(e,r,"write to private field"),n?n.call(e,t):r.set(e,t),t),o=(e,r,t)=>(pe(e,r,"access private method"),t);var de=(e,r,t,n)=>({set _(i){d(e,r,i,t)},get _(){return a(e,r,n)}});var Vt={};qe(Vt,{LeaderChangedError:()=>ce,PGliteWorker:()=>Re,worker:()=>Wt});module.exports=$e(Vt);var je=()=>typeof document>"u"?new URL(`file:${__filename}`).href:document.currentScript&&document.currentScript.src||new URL("main.js",document.baseURI).href,T=je();var Me={part:"part",container:"container"};function te(e,r,...t){let n=e.length-1,i=t.length-1;if(i!==-1){if(i===0){e[n]=e[n]+t[0]+r;return}e[n]=e[n]+t[0],e.push(...t.slice(1,i)),e.push(t[i]+r)}}function He(e,...r){let t=[e[0]];t.raw=[e.raw[0]];let n=[];for(let i=0;i<r.length;i++){let s=r[i],c=i+1;if(s?._templateType===Me.part){te(t,e[c],s.str),te(t.raw,e.raw[c],s.str);continue}if(s?._templateType===Me.container){te(t,e[c],...s.strings),te(t.raw,e.raw[c],...s.strings.raw),n.push(...s.values);continue}t.push(e[c]),t.raw.push(e.raw[c]),n.push(s)}return{_templateType:"container",strings:t,values:n}}function ye(e,...r){let{strings:t,values:n}=He(e,...r);return{query:[t[0],...n.flatMap((i,s)=>[`$${s+1}`,t[s+1]])].join(""),params:n}}var Ye=globalThis.JSON.parse,Ke=globalThis.JSON.stringify,Ie=16,ke=17;var De=20,Je=21,Xe=23;var fe=25,Ze=26;var Le=114;var et=700,tt=701;var rt=1042,nt=1043,st=1082;var at=1114,Ce=1184;var it=3802;var ot={string:{to:fe,from:[fe,nt,rt],serialize:e=>{if(typeof e=="string")return e;if(typeof e=="number")return e.toString();throw new Error("Invalid input for string type")},parse:e=>e},number:{to:0,from:[Je,Xe,Ze,et,tt],serialize:e=>e.toString(),parse:e=>+e},bigint:{to:De,from:[De],serialize:e=>e.toString(),parse:e=>{let r=BigInt(e);return r<Number.MIN_SAFE_INTEGER||r>Number.MAX_SAFE_INTEGER?r:Number(r)}},json:{to:Le,from:[Le,it],serialize:e=>Ke(e),parse:e=>Ye(e)},boolean:{to:Ie,from:[Ie],serialize:e=>{if(typeof e!="boolean")throw new Error("Invalid input for boolean type");return e?"t":"f"},parse:e=>e==="t"},date:{to:Ce,from:[st,at,Ce],serialize:e=>{if(typeof e=="string")return e;if(typeof e=="number")return new Date(e).toISOString();if(e instanceof Date)return e.toISOString();throw new Error("Invalid input for date type")},parse:e=>new Date(e)},bytea:{to:ke,from:[ke],serialize:e=>{if(!(e instanceof Uint8Array))throw new Error("Invalid input for bytea type");return"\\x"+Array.from(e).map(r=>r.toString(16).padStart(2,"0")).join("")},parse:e=>{let r=e.slice(2);return Uint8Array.from({length:r.length/2},(t,n)=>parseInt(r.substring(n*2,(n+1)*2),16))}}},he=ct(ot),Oe=he.parsers,ve=he.serializers;function ge(e,r,t){if(e===null)return null;let n=t?.[r]??he.parsers[r];return n?n(e,r):e}function ct(e){return Object.keys(e).reduce(({parsers:r,serializers:t},n)=>{let{to:i,from:s,serialize:c,parse:y}=e[n];return t[i]=c,t[n]=c,r[n]=y,Array.isArray(s)?s.forEach(l=>{r[l]=y,t[l]=c}):(r[s]=y,t[s]=c),{parsers:r,serializers:t}},{parsers:{},serializers:{}})}var lt=/\\/g,ut=/"/g;function pt(e){return e.replace(lt,"\\\\").replace(ut,'\\"')}function be(e,r,t){if(Array.isArray(e)===!1)return e;if(!e.length)return"{}";let n=e[0],i=t===1020?";":",";return Array.isArray(n)?`{${e.map(s=>be(s,r,t)).join(i)}}`:`{${e.map(s=>(s===void 0&&(s=null),s===null?"null":'"'+pt(r?r(s):s.toString())+'"')).join(i)}}`}var me={i:0,char:null,str:"",quoted:!1,last:0,p:null};function Ue(e,r,t){return me.i=me.last=0,Ne(me,e,r,t)[0]}function Ne(e,r,t,n){let i=[],s=n===1020?";":",";for(;e.i<r.length;e.i++){if(e.char=r[e.i],e.quoted)e.char==="\\"?e.str+=r[++e.i]:e.char==='"'?(i.push(t?t(e.str):e.str),e.str="",e.quoted=r[e.i+1]==='"',e.last=e.i+2):e.str+=e.char;else if(e.char==='"')e.quoted=!0;else if(e.char==="{")e.last=++e.i,i.push(Ne(e,r,t,n));else if(e.char==="}"){e.quoted=!1,e.last<e.i&&i.push(t?t(r.slice(e.last,e.i)):r.slice(e.last,e.i)),e.last=e.i+1;break}else e.char===s&&e.p!=="}"&&e.p!=='"'&&(i.push(t?t(r.slice(e.last,e.i)):r.slice(e.last,e.i)),e.last=e.i+1);e.p=e.char}return e.last<e.i&&i.push(t?t(r.slice(e.last,e.i+1)):r.slice(e.last,e.i+1)),i}function we(e,r,t,n){let i=[],s={rows:[],fields:[]},c=0,y={...r,...t?.parsers},l=e.filter(u=>u.name==="rowDescription"||u.name==="dataRow"||u.name==="commandComplete");return l.forEach((u,m)=>{if(u.name==="rowDescription"){let x=u;s.fields=x.fields.map(b=>({name:b.name,dataTypeID:b.dataTypeID}))}else if(u.name==="dataRow"&&s){let x=u;t?.rowMode==="array"?s.rows.push(x.fields.map((b,L)=>ge(b,s.fields[L].dataTypeID,y))):s.rows.push(Object.fromEntries(x.fields.map((b,L)=>[s.fields[L].name,ge(b,s.fields[L].dataTypeID,y)])))}else u.name==="commandComplete"&&(c+=dt(u),m===l.length-1?i.push({...s,affectedRows:c,...n?{blob:n}:{}}):i.push(s),s={rows:[],fields:[]})}),i.length===0&&i.push({rows:[],fields:[]}),i}function dt(e){let r=e.text.split(" ");switch(r[0]){case"INSERT":return parseInt(r[2],10);case"UPDATE":case"DELETE":return parseInt(r[1],10);default:return 0}}function Ae(e){let r=e.find(t=>t.name==="parameterDescription");return r?r.dataTypeIDs:[]}function W(e){let r=e.length;for(let t=e.length-1;t>=0;t--){let n=e.charCodeAt(t);n>127&&n<=2047?r++:n>2047&&n<=65535&&(r+=2),n>=56320&&n<=57343&&t--}return r}var w,A,F,ne,V,P,re,G,_e,C=class{constructor(r=256){this.size=r;p(this,P);p(this,w);p(this,A,5);p(this,F,!1);p(this,ne,new TextEncoder);p(this,V,0);d(this,w,o(this,P,re).call(this,r))}addInt32(r){return o(this,P,G).call(this,4),a(this,w).setInt32(a(this,A),r,a(this,F)),d(this,A,a(this,A)+4),this}addInt16(r){return o(this,P,G).call(this,2),a(this,w).setInt16(a(this,A),r,a(this,F)),d(this,A,a(this,A)+2),this}addCString(r){return r&&this.addString(r),o(this,P,G).call(this,1),a(this,w).setUint8(a(this,A),0),de(this,A)._++,this}addString(r=""){let t=W(r);return o(this,P,G).call(this,t),a(this,ne).encodeInto(r,new Uint8Array(a(this,w).buffer,a(this,A))),d(this,A,a(this,A)+t),this}add(r){return o(this,P,G).call(this,r.byteLength),new Uint8Array(a(this,w).buffer).set(new Uint8Array(r),a(this,A)),d(this,A,a(this,A)+r.byteLength),this}flush(r){let t=o(this,P,_e).call(this,r);return d(this,A,5),d(this,w,o(this,P,re).call(this,this.size)),new Uint8Array(t)}};w=new WeakMap,A=new WeakMap,F=new WeakMap,ne=new WeakMap,V=new WeakMap,P=new WeakSet,re=function(r){return new DataView(new ArrayBuffer(r))},G=function(r){if(a(this,w).byteLength-a(this,A)<r){let n=a(this,w).buffer,i=n.byteLength+(n.byteLength>>1)+r;d(this,w,o(this,P,re).call(this,i)),new Uint8Array(a(this,w).buffer).set(new Uint8Array(n))}},_e=function(r){if(r){a(this,w).setUint8(a(this,V),r);let t=a(this,A)-(a(this,V)+1);a(this,w).setInt32(a(this,V)+1,t,a(this,F))}return a(this,w).buffer.slice(r?0:5,a(this,A))};var h=new C,yt=e=>{h.addInt16(3).addInt16(0);for(let n of Object.keys(e))h.addCString(n).addCString(e[n]);h.addCString("client_encoding").addCString("UTF8");let r=h.addCString("").flush(),t=r.byteLength+4;return new C().addInt32(t).add(r).flush()},mt=()=>{let e=new DataView(new ArrayBuffer(8));return e.setInt32(0,8,!1),e.setInt32(4,80877103,!1),new Uint8Array(e.buffer)},ft=e=>h.addCString(e).flush(112),ht=(e,r)=>(h.addCString(e).addInt32(W(r)).addString(r),h.flush(112)),gt=e=>h.addString(e).flush(112),bt=e=>h.addCString(e).flush(81),wt=[],At=e=>{let r=e.name??"";r.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",r,r.length),console.error("This can cause conflicts and silent errors executing queries"));let t=h.addCString(r).addCString(e.text).addInt16(e.types?.length??0);return e.types?.forEach(n=>t.addInt32(n)),h.flush(80)},Q=new C;var Tt=(e,r)=>{for(let t=0;t<e.length;t++){let n=r?r(e[t],t):e[t];if(n===null)h.addInt16(0),Q.addInt32(-1);else if(n instanceof ArrayBuffer||ArrayBuffer.isView(n)){let i=ArrayBuffer.isView(n)?n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength):n;h.addInt16(1),Q.addInt32(i.byteLength),Q.add(i)}else h.addInt16(0),Q.addInt32(W(n)),Q.addString(n)}},xt=(e={})=>{let r=e.portal??"",t=e.statement??"",n=e.binary??!1,i=e.values??wt,s=i.length;return h.addCString(r).addCString(t),h.addInt16(s),Tt(i,e.valueMapper),h.addInt16(s),h.add(Q.flush()),h.addInt16(n?1:0),h.flush(66)},Pt=new Uint8Array([69,0,0,0,9,0,0,0,0,0]),Rt=e=>{if(!e||!e.portal&&!e.rows)return Pt;let r=e.portal??"",t=e.rows??0,n=W(r),i=4+n+1+4,s=new DataView(new ArrayBuffer(1+i));return s.setUint8(0,69),s.setInt32(1,i,!1),new TextEncoder().encodeInto(r,new Uint8Array(s.buffer,5)),s.setUint8(n+5,0),s.setUint32(s.byteLength-4,t,!1),new Uint8Array(s.buffer)},Bt=(e,r)=>{let t=new DataView(new ArrayBuffer(16));return t.setInt32(0,16,!1),t.setInt16(4,1234,!1),t.setInt16(6,5678,!1),t.setInt32(8,e,!1),t.setInt32(12,r,!1),new Uint8Array(t.buffer)},Te=(e,r)=>{let t=new C;return t.addCString(r),t.flush(e)},Et=h.addCString("P").flush(68),St=h.addCString("S").flush(68),Mt=e=>e.name?Te(68,`${e.type}${e.name??""}`):e.type==="P"?Et:St,It=e=>{let r=`${e.type}${e.name??""}`;return Te(67,r)},kt=e=>h.add(e).flush(100),Dt=e=>Te(102,e),se=e=>new Uint8Array([e,0,0,0,4]),Lt=se(72),Ct=se(83),Ot=se(88),vt=se(99),E={startup:yt,password:ft,requestSsl:mt,sendSASLInitialResponseMessage:ht,sendSCRAMClientFinalMessage:gt,query:bt,parse:At,bind:xt,execute:Rt,describe:Mt,close:It,flush:()=>Lt,sync:()=>Ct,end:()=>Ot,copyData:kt,copyDone:()=>vt,copyFail:Dt,cancel:Bt};var pr=new ArrayBuffer(0);var Nt=1,_t=4,Jr=Nt+_t,Xr=new ArrayBuffer(0);var $,D,f,I,ae,O,xe,ie=class{constructor(){p(this,f);this.serializers={...ve};this.parsers={...Oe};p(this,$,!1);p(this,D,!1)}async _initArrayTypes(){if(a(this,$))return;d(this,$,!0);let r=await this.query(`
      SELECT b.oid, b.typarray
      FROM pg_catalog.pg_type a
      LEFT JOIN pg_catalog.pg_type b ON b.oid = a.typelem
      WHERE a.typcategory = 'A'
      GROUP BY b.oid, b.typarray
      ORDER BY b.oid
    `);for(let t of r.rows)this.serializers[t.typarray]=n=>be(n,this.serializers[t.oid],t.typarray),this.parsers[t.typarray]=n=>Ue(n,this.parsers[t.oid],t.typarray)}async query(r,t,n){return await this._checkReady(),await this._runExclusiveTransaction(async()=>await o(this,f,ae).call(this,r,t,n))}async sql(r,...t){let{query:n,params:i}=ye(r,...t);return await this.query(n,i)}async exec(r,t){return await this._checkReady(),await this._runExclusiveTransaction(async()=>await o(this,f,O).call(this,r,t))}async transaction(r){return await this._checkReady(),await this._runExclusiveTransaction(async()=>{await o(this,f,O).call(this,"BEGIN"),d(this,D,!0);let t=!1,n=()=>{if(t)throw new Error("Transaction is closed")},i={query:async(s,c,y)=>(n(),await o(this,f,ae).call(this,s,c,y)),sql:async(s,...c)=>{let{query:y,params:l}=ye(s,...c);return await o(this,f,ae).call(this,y,l)},exec:async(s,c)=>(n(),await o(this,f,O).call(this,s,c)),rollback:async()=>{n(),await o(this,f,O).call(this,"ROLLBACK"),t=!0},get closed(){return t}};try{let s=await r(i);return t||(t=!0,await o(this,f,O).call(this,"COMMIT")),d(this,D,!1),s}catch(s){throw t||await o(this,f,O).call(this,"ROLLBACK"),d(this,D,!1),s}})}};$=new WeakMap,D=new WeakMap,f=new WeakSet,I=async function(r,t={}){return await this.execProtocol(r,{...t,syncToFs:!1})},ae=async function(r,t=[],n){return await this._runExclusiveQuery(async()=>{o(this,f,xe).call(this,"runQuery",r,t,n),await this._handleBlob(n?.blob);let i;try{let c=await o(this,f,I).call(this,E.parse({text:r,types:n?.paramTypes}),n),y=Ae((await o(this,f,I).call(this,E.describe({type:"S"}),n)).map(([u])=>u)),l=t.map((u,m)=>{let x=y[m];if(u==null)return null;let b=this.serializers[x];return b?b(u):u.toString()});i=[...c,...await o(this,f,I).call(this,E.bind({values:l}),n),...await o(this,f,I).call(this,E.describe({type:"P"}),n),...await o(this,f,I).call(this,E.execute({}),n)]}finally{await o(this,f,I).call(this,E.sync(),n)}await this._cleanupBlob(),a(this,D)||await this.syncToFs();let s=await this._getWrittenBlob();return we(i.map(([c])=>c),this.parsers,n,s)[0]})},O=async function(r,t){return await this._runExclusiveQuery(async()=>{o(this,f,xe).call(this,"runExec",r,t),await this._handleBlob(t?.blob);let n;try{n=await o(this,f,I).call(this,E.query(r),t)}finally{await o(this,f,I).call(this,E.sync(),t)}this._cleanupBlob(),a(this,D)||await this.syncToFs();let i=await this._getWrittenBlob();return we(n.map(([s])=>s),this.parsers,t,i)})},xe=function(...r){this.debug>0&&console.log(...r)};var bn=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string";var Pe=()=>{if(globalThis.crypto?.randomUUID)return globalThis.crypto.randomUUID();let e=new Uint8Array(16);if(globalThis.crypto?.getRandomValues)globalThis.crypto.getRandomValues(e);else for(let t=0;t<e.length;t++)e[t]=Math.floor(Math.random()*256);e[6]=e[6]&15|64,e[8]=e[8]&63|128;let r=[];return e.forEach(t=>{r.push(t.toString(16).padStart(2,"0"))}),r.slice(0,4).join("")+"-"+r.slice(4,6).join("")+"-"+r.slice(6,8).join("")+"-"+r.slice(8,10).join("")+"-"+r.slice(10).join("")};var q,j,H,z,Y,B,v,U,S,K,J,X,N,k,Z,M,_,ee,le,g,We,oe,R,Ge,Ee=class Ee extends ie{constructor(t,n){super();p(this,g);p(this,q);p(this,j,0);p(this,H,!1);p(this,z,!1);p(this,Y,!1);p(this,B,new EventTarget);p(this,v);p(this,U,!1);p(this,S);p(this,K);p(this,J);p(this,X);p(this,N);p(this,k);p(this,Z);p(this,M,new Map);p(this,_,new Set);p(this,ee);p(this,le,[]);d(this,S,t),d(this,v,Pe()),d(this,ee,n?.extensions??{}),d(this,J,new Promise(i=>{a(this,S).addEventListener("message",s=>{if(s.data.type==="here")i();else throw new Error("Invalid message")},{once:!0})})),d(this,X,new Promise(i=>{let s=c=>{c.data.type==="ready"&&(d(this,K,c.data.id),a(this,S).removeEventListener("message",s),i())};a(this,S).addEventListener("message",s)})),d(this,q,o(this,g,We).call(this,n))}static async create(t,n){let i=new Ee(t,n);return await a(i,q),i}get waitReady(){return new Promise(t=>{a(this,q).then(()=>{a(this,U)?t():t(new Promise(n=>{a(this,B).addEventListener("connected",()=>{n()})}))})})}get debug(){return a(this,j)}get ready(){return a(this,H)}get closed(){return a(this,z)}get isLeader(){return a(this,Y)}async close(){var t;a(this,z)||(d(this,z,!0),a(this,N)?.close(),a(this,k)?.close(),(t=a(this,Z))==null||t.call(this),a(this,S).terminate())}async[Symbol.asyncDispose](){await this.close()}async execProtocolRaw(t){return await o(this,g,R).call(this,"execProtocolRaw",t)}async execProtocol(t){return await o(this,g,R).call(this,"execProtocol",t)}async syncToFs(){await o(this,g,R).call(this,"syncToFs")}async listen(t,n){return await this.waitReady,a(this,M).has(t)||a(this,M).set(t,new Set),a(this,M).get(t)?.add(n),await this.exec(`LISTEN ${t}`),async()=>{await this.unlisten(t,n)}}async unlisten(t,n){await this.waitReady,n?a(this,M).get(t)?.delete(n):a(this,M).delete(t),a(this,M).get(t)?.size===0&&await this.exec(`UNLISTEN ${t}`)}onNotification(t){return a(this,_).add(t),()=>{a(this,_).delete(t)}}offNotification(t){a(this,_).delete(t)}async dumpDataDir(){return await o(this,g,R).call(this,"dumpDataDir")}onLeaderChange(t){return a(this,B).addEventListener("leader-change",t),()=>{a(this,B).removeEventListener("leader-change",t)}}offLeaderChange(t){a(this,B).removeEventListener("leader-change",t)}async _handleBlob(t){await o(this,g,R).call(this,"_handleBlob",t)}async _getWrittenBlob(){return await o(this,g,R).call(this,"_getWrittenBlob")}async _cleanupBlob(){await o(this,g,R).call(this,"_cleanupBlob")}async _checkReady(){await this.waitReady}async _runExclusiveQuery(t){await o(this,g,R).call(this,"_acquireQueryLock");try{return await t()}finally{await o(this,g,R).call(this,"_releaseQueryLock")}}async _runExclusiveTransaction(t){await o(this,g,R).call(this,"_acquireTransactionLock");try{return await t()}finally{await o(this,g,R).call(this,"_releaseTransactionLock")}}};q=new WeakMap,j=new WeakMap,H=new WeakMap,z=new WeakMap,Y=new WeakMap,B=new WeakMap,v=new WeakMap,U=new WeakMap,S=new WeakMap,K=new WeakMap,J=new WeakMap,X=new WeakMap,N=new WeakMap,k=new WeakMap,Z=new WeakMap,M=new WeakMap,_=new WeakMap,ee=new WeakMap,le=new WeakMap,g=new WeakSet,We=async function(t={}){for(let[l,u]of Object.entries(a(this,ee))){if(u instanceof URL)throw new Error("URL extensions are not supported on the client side of a worker");{let m=await u.setup(this,{},!0);if(m.emscriptenOpts&&console.warn(`PGlite extension ${l} returned emscriptenOpts, these are not supported on the client side of a worker`),m.namespaceObj){let x=this;x[l]=m.namespaceObj}m.bundlePath&&console.warn(`PGlite extension ${l} returned bundlePath, this is not supported on the client side of a worker`),m.init&&await m.init(),m.close&&a(this,le).push(m.close)}}await a(this,J);let{extensions:n,...i}=t;a(this,S).postMessage({type:"init",options:i}),await a(this,X);let s=`pglite-tab-close:${a(this,v)}`;d(this,Z,await Be(s));let c=`pglite-broadcast:${a(this,K)}`;d(this,N,new BroadcastChannel(c));let y=`pglite-tab:${a(this,v)}`;d(this,k,new BroadcastChannel(y)),a(this,N).addEventListener("message",async l=>{l.data.type==="leader-here"?(d(this,U,!1),a(this,B).dispatchEvent(new Event("leader-change")),o(this,g,oe).call(this)):l.data.type==="notify"&&o(this,g,Ge).call(this,l.data.channel,l.data.payload)}),a(this,k).addEventListener("message",async l=>{l.data.type==="connected"&&(d(this,U,!0),a(this,B).dispatchEvent(new Event("connected")),d(this,j,await o(this,g,R).call(this,"getDebugLevel")),d(this,H,!0))}),a(this,S).addEventListener("message",async l=>{l.data.type==="leader-now"&&(d(this,Y,!0),a(this,B).dispatchEvent(new Event("leader-change")))}),o(this,g,oe).call(this),this._initArrayTypes()},oe=async function(){a(this,U)||(a(this,N).postMessage({type:"tab-here",id:a(this,v)}),setTimeout(()=>o(this,g,oe).call(this),16))},R=async function(t,...n){let i=Pe(),s={type:"rpc-call",callId:i,method:t,args:n};return a(this,k).postMessage(s),await new Promise((c,y)=>{let l=x=>{if(x.data.callId!==i)return;m();let b=x.data;if(b.type==="rpc-return")c(b.result);else if(b.type==="rpc-error"){let L=new Error(b.error.message);Object.assign(L,b.error),y(L)}else y(new Error("Invalid message"))},u=()=>{m(),y(new ce)},m=()=>{a(this,k).removeEventListener("message",l),a(this,B).removeEventListener("leader-change",u)};a(this,B).addEventListener("leader-change",u),a(this,k).addEventListener("message",l)})},Ge=function(t,n){let i=a(this,M).get(t);if(i)for(let s of i)queueMicrotask(()=>s(n));for(let s of a(this,_))queueMicrotask(()=>s(t,n))};var Re=Ee;async function Wt({init:e}){postMessage({type:"here"});let r=await new Promise(u=>{addEventListener("message",m=>{m.data.type==="init"&&u(m.data.options)},{once:!0})}),t=r.id??`${T}:${r.dataDir??""}`;postMessage({type:"ready",id:t});let n=`pglite-election-lock:${t}`,i=`pglite-broadcast:${t}`,s=new BroadcastChannel(i),c=new Set;await Be(n);let y=e(r);s.onmessage=async u=>{let m=u.data;switch(m.type){case"tab-here":Gt(m.id,await y,c);break}},s.postMessage({type:"leader-here",id:t}),postMessage({type:"leader-now"}),(await y).onNotification((u,m)=>{s.postMessage({type:"notify",channel:u,payload:m})})}function Gt(e,r,t){if(t.has(e))return;t.add(e);let n=`pglite-tab:${e}`,i=`pglite-tab-close:${e}`,s=new BroadcastChannel(n);navigator.locks.request(i,()=>new Promise(y=>{s.close(),t.delete(e),y()}));let c=Ft(e,r);s.addEventListener("message",async y=>{let l=y.data;switch(l.type){case"rpc-call":{await r.waitReady;let{callId:u,method:m,args:x}=l;try{let b=await c[m](...x);s.postMessage({type:"rpc-return",callId:u,result:b})}catch(b){console.error(b),s.postMessage({type:"rpc-error",callId:u,error:{message:b.message}})}break}}}),s.postMessage({type:"connected"})}function Ft(e,r){let t=null,n=null,i=`pglite-tab-close:${e}`;return Be(i).then(()=>{n&&r.exec("ROLLBACK"),t?.(),n?.()}),{async getDebugLevel(){return r.debug},async close(){await r.close()},async execProtocol(s){return(await r.execProtocol(s)).map(([y,l])=>{if(l.byteLength!==l.buffer.byteLength){let u=new ArrayBuffer(l.byteLength),m=new Uint8Array(u);return m.set(l),[y,m]}else return[y,l]})},async execProtocolRaw(s){let c=await r.execProtocolRaw(s);if(c.byteLength!==c.buffer.byteLength){let y=new ArrayBuffer(c.byteLength),l=new Uint8Array(y);return l.set(c),l}else return c},async dumpDataDir(){return await r.dumpDataDir()},async syncToFs(){return await r.syncToFs()},async _handleBlob(s){return await r._handleBlob(s)},async _getWrittenBlob(){return await r._getWrittenBlob()},async _cleanupBlob(){return await r._cleanupBlob()},async _checkReady(){return await r._checkReady()},async _acquireQueryLock(){return new Promise(s=>{r._runExclusiveQuery(()=>new Promise(c=>{t=c,s()}))})},async _releaseQueryLock(){t?.(),t=null},async _acquireTransactionLock(){return new Promise(s=>{r._runExclusiveTransaction(()=>new Promise(c=>{n=c,s()}))})},async _releaseTransactionLock(){n?.(),n=null}}}var ce=class extends Error{constructor(){super("Leader changed, pending operation in indeterminate state")}};async function Be(e){let r;return await new Promise(t=>{navigator.locks.request(e,()=>new Promise(n=>{r=n,t()}))}),r}0&&(module.exports={LeaderChangedError,PGliteWorker,worker});
//# sourceMappingURL=index.cjs.map