"use strict";var nt=Object.create;var re=Object.defineProperty;var it=Object.getOwnPropertyDescriptor;var ot=Object.getOwnPropertyNames;var st=Object.getPrototypeOf,at=Object.prototype.hasOwnProperty;var ve=t=>{throw TypeError(t)};var E=(t,e)=>()=>(t&&(e=t(t=0)),e);var L=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),ct=(t,e)=>{for(var r in e)re(t,r,{get:e[r],enumerable:!0})},De=(t,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ot(e))!at.call(t,n)&&n!==r&&re(t,n,{get:()=>e[n],enumerable:!(i=it(e,n))||i.enumerable});return t};var fe=(t,e,r)=>(r=t!=null?nt(st(t)):{},De(e||!t||!t.__esModule?re(r,"default",{value:t,enumerable:!0}):r,t)),pt=t=>De(re({},"__esModule",{value:!0}),t);var he=(t,e,r)=>e.has(t)||ve("Cannot "+r);var p=(t,e,r)=>(he(t,e,"read from private field"),r?r.call(t):e.get(t)),g=(t,e,r)=>e.has(t)?ve("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),T=(t,e,r,i)=>(he(t,e,"write to private field"),i?i.call(t,r):e.set(t,r),r),u=(t,e,r)=>(he(t,e,"access private method"),r);var ye=(t,e,r,i)=>({set _(n){T(t,e,n,r)},get _(){return p(t,e,i)}});var m=E(()=>{"use strict"});var j,ne=E(()=>{"use strict";m();j=class{constructor(e){this.dataDir=e}async syncToFs(e,r){}async initialSyncFs(e){}async close(e){}}});var Y=L((Qt,A)=>{"use strict";m();var ke=9007199254740991,Ie=function(t){return t}();function dt(t){return t===Ie}function Me(t){return typeof t=="string"||Object.prototype.toString.call(t)=="[object String]"}function lt(t){return Object.prototype.toString.call(t)=="[object Date]"}function ie(t){return t!==null&&typeof t=="object"}function oe(t){return typeof t=="function"}function ut(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=ke}function mt(t){return Object.prototype.toString.call(t)=="[object Array]"}function ze(t){return ie(t)&&!oe(t)&&ut(t.length)}function Se(t){return Object.prototype.toString.call(t)=="[object ArrayBuffer]"}function ft(t,e){return Array.prototype.map.call(t,e)}function ht(t,e){var r=Ie;return oe(e)&&Array.prototype.every.call(t,function(i,n,o){var s=e(i,n,o);return s&&(r=i),!s}),r}function yt(t){return Object.assign.apply(null,arguments)}function _e(t){var e,r,i;if(Me(t)){for(r=t.length,i=new Uint8Array(r),e=0;e<r;e++)i[e]=t.charCodeAt(e)&255;return i}return Se(t)?new Uint8Array(t):ie(t)&&Se(t.buffer)?new Uint8Array(t.buffer):ze(t)?new Uint8Array(t):ie(t)&&oe(t.toString)?_e(t.toString()):new Uint8Array}A.exports.MAX_SAFE_INTEGER=ke;A.exports.isUndefined=dt;A.exports.isString=Me;A.exports.isObject=ie;A.exports.isDateTime=lt;A.exports.isFunction=oe;A.exports.isArray=mt;A.exports.isArrayLike=ze;A.exports.isArrayBuffer=Se;A.exports.map=ft;A.exports.find=ht;A.exports.extend=yt;A.exports.toUint8Array=_e});var X=L((tr,Ce)=>{"use strict";m();var ge="\0";Ce.exports={NULL_CHAR:ge,TMAGIC:"ustar"+ge+"00",OLDGNU_MAGIC:"ustar  "+ge,REGTYPE:0,LNKTYPE:1,SYMTYPE:2,CHRTYPE:3,BLKTYPE:4,DIRTYPE:5,FIFOTYPE:6,CONTTYPE:7,TSUID:parseInt("4000",8),TSGID:parseInt("2000",8),TSVTX:parseInt("1000",8),TUREAD:parseInt("0400",8),TUWRITE:parseInt("0200",8),TUEXEC:parseInt("0100",8),TGREAD:parseInt("0040",8),TGWRITE:parseInt("0020",8),TGEXEC:parseInt("0010",8),TOREAD:parseInt("0004",8),TOWRITE:parseInt("0002",8),TOEXEC:parseInt("0001",8),TPERMALL:parseInt("0777",8),TPERMMASK:parseInt("0777",8)}});var be=L((nr,O)=>{"use strict";m();var Ue=Y(),F=X(),St=512,Fe=F.TPERMALL,Re=0,He=0,we=[["name",100,0,function(t,e){return $(t[e[0]],e[1])},function(t,e,r){return C(t.slice(e,e+r[1]))}],["mode",8,100,function(t,e){var r=t[e[0]]||Fe;return r=r&F.TPERMMASK,B(r,e[1],Fe)},function(t,e,r){var i=k(t.slice(e,e+r[1]));return i&=F.TPERMMASK,i}],["uid",8,108,function(t,e){return B(t[e[0]],e[1],Re)},function(t,e,r){return k(t.slice(e,e+r[1]))}],["gid",8,116,function(t,e){return B(t[e[0]],e[1],He)},function(t,e,r){return k(t.slice(e,e+r[1]))}],["size",12,124,function(t,e){return B(t.data.length,e[1])},function(t,e,r){return k(t.slice(e,e+r[1]))}],["modifyTime",12,136,function(t,e){return se(t[e[0]],e[1])},function(t,e,r){return ae(t.slice(e,e+r[1]))}],["checksum",8,148,function(t,e){return"        "},function(t,e,r){return k(t.slice(e,e+r[1]))}],["type",1,156,function(t,e){return""+(parseInt(t[e[0]],10)||0)%8},function(t,e,r){return(parseInt(String.fromCharCode(t[e]),10)||0)%8}],["linkName",100,157,function(t,e){return""},function(t,e,r){return C(t.slice(e,e+r[1]))}],["ustar",8,257,function(t,e){return F.TMAGIC},function(t,e,r){return gt(C(t.slice(e,e+r[1]),!0))},function(t,e){return t[e[0]]==F.TMAGIC||t[e[0]]==F.OLDGNU_MAGIC}],["owner",32,265,function(t,e){return $(t[e[0]],e[1])},function(t,e,r){return C(t.slice(e,e+r[1]))}],["group",32,297,function(t,e){return $(t[e[0]],e[1])},function(t,e,r){return C(t.slice(e,e+r[1]))}],["majorNumber",8,329,function(t,e){return""},function(t,e,r){return k(t.slice(e,e+r[1]))}],["minorNumber",8,337,function(t,e){return""},function(t,e,r){return k(t.slice(e,e+r[1]))}],["prefix",131,345,function(t,e){return $(t[e[0]],e[1])},function(t,e,r){return C(t.slice(e,e+r[1]))}],["accessTime",12,476,function(t,e){return se(t[e[0]],e[1])},function(t,e,r){return ae(t.slice(e,e+r[1]))}],["createTime",12,488,function(t,e){return se(t[e[0]],e[1])},function(t,e,r){return ae(t.slice(e,e+r[1]))}]],Le=function(t){var e=t[t.length-1];return e[2]+e[1]}(we);function gt(t){if(t.length==8){var e=t.split("");if(e[5]==F.NULL_CHAR)return(e[6]==" "||e[6]==F.NULL_CHAR)&&(e[6]="0"),(e[7]==" "||e[7]==F.NULL_CHAR)&&(e[7]="0"),e=e.join(""),e==F.TMAGIC?e:t;if(e[7]==F.NULL_CHAR)return e[5]==F.NULL_CHAR&&(e[5]=" "),e[6]==F.NULL_CHAR&&(e[6]=" "),e==F.OLDGNU_MAGIC?e:t}return t}function $(t,e){return e-=1,Ue.isUndefined(t)&&(t=""),t=(""+t).substr(0,e),t+F.NULL_CHAR}function B(t,e,r){for(r=parseInt(r)||0,e-=1,t=(parseInt(t)||r).toString(8).substr(-e,e);t.length<e;)t="0"+t;return t+F.NULL_CHAR}function se(t,e){if(Ue.isDateTime(t))t=Math.floor(1*t/1e3);else if(t=parseInt(t,10),isFinite(t)){if(t<=0)return""}else t=Math.floor(1*new Date/1e3);return B(t,e,0)}function C(t,e){var r=String.fromCharCode.apply(null,t);if(e)return r;var i=r.indexOf(F.NULL_CHAR);return i>=0?r.substr(0,i):r}function k(t){var e=String.fromCharCode.apply(null,t);return parseInt(e.replace(/^0+$/g,""),8)||0}function ae(t){return t.length==0||t[0]==0?null:new Date(1e3*k(t))}function Ft(t,e,r){var i=parseInt(e,10)||0,n=Math.min(i+Le,t.length),o=0,s=0,a=0;r&&we.every(function(S){return S[0]=="checksum"?(s=i+S[2],a=s+S[1],!1):!0});for(var c=32,l=i;l<n;l++){var y=l>=s&&l<a?c:t[l];o=(o+y)%262144}return o}O.exports.recordSize=St;O.exports.defaultFileMode=Fe;O.exports.defaultUid=Re;O.exports.defaultGid=He;O.exports.posixHeader=we;O.exports.effectiveHeaderSize=Le;O.exports.calculateChecksum=Ft;O.exports.formatTarString=$;O.exports.formatTarNumber=B;O.exports.formatTarDateTime=se;O.exports.parseTarString=C;O.exports.parseTarNumber=k;O.exports.parseTarDateTime=ae});var We=L((or,Ge)=>{"use strict";m();var wt=X(),ce=Y(),M=be();function je(t){return M.recordSize}function Be(t){return Math.ceil(t.data.length/M.recordSize)*M.recordSize}function bt(t){var e=0;return t.forEach(function(r){e+=je(r)+Be(r)}),e+=M.recordSize*2,new Uint8Array(e)}function Pt(t,e,r){r=parseInt(r)||0;var i=r;M.posixHeader.forEach(function(c){for(var l=c[3](e,c),y=l.length,S=0;S<y;S+=1)t[i+S]=l.charCodeAt(S)&255;i+=c[1]});var n=ce.find(M.posixHeader,function(c){return c[0]=="checksum"});if(n){var o=M.calculateChecksum(t,r,!0),s=M.formatTarNumber(o,n[1]-2)+wt.NULL_CHAR+" ";i=r+n[2];for(var a=0;a<s.length;a+=1)t[i]=s.charCodeAt(a)&255,i++}return r+je(e)}function Nt(t,e,r){return r=parseInt(r,10)||0,t.set(e.data,r),r+Be(e)}function At(t){t=ce.map(t,function(i){return ce.extend({},i,{data:ce.toUint8Array(i.data)})});var e=bt(t),r=0;return t.forEach(function(i){r=Pt(e,i,r),r=Nt(e,i,r)}),e}Ge.exports.tar=At});var Ye=L((ar,qe)=>{"use strict";m();var Ot=X(),Ne=Y(),x=be(),Tt={extractData:!0,checkHeader:!0,checkChecksum:!0,checkFileSize:!0},Et={size:!0,checksum:!0,ustar:!0},Pe={unexpectedEndOfFile:"Unexpected end of file.",fileCorrupted:"File is corrupted.",checksumCheckFailed:"Checksum check failed."};function xt(t){return x.recordSize}function vt(t){return Math.ceil(t/x.recordSize)*x.recordSize}function Dt(t,e){for(var r=e,i=Math.min(t.length,e+x.recordSize*2),n=r;n<i;n++)if(t[n]!=0)return!1;return!0}function kt(t,e,r){if(t.length-e<x.recordSize){if(r.checkFileSize)throw new Error(Pe.unexpectedEndOfFile);return null}e=parseInt(e)||0;var i={},n=e;if(x.posixHeader.forEach(function(a){i[a[0]]=a[4](t,n,a),n+=a[1]}),i.type!=0&&(i.size=0),r.checkHeader&&x.posixHeader.forEach(function(a){if(Ne.isFunction(a[5])&&!a[5](i,a)){var c=new Error(Pe.fileCorrupted);throw c.data={offset:e+a[2],field:a[0]},c}}),r.checkChecksum){var o=x.calculateChecksum(t,e,!0);if(o!=i.checksum){var s=new Error(Pe.checksumCheckFailed);throw s.data={offset:e,header:i,checksum:o},s}}return i}function It(t,e,r,i){return i.extractData?r.size<=0?new Uint8Array:t.slice(e,e+r.size):null}function Mt(t,e){var r={};return x.posixHeader.forEach(function(i){var n=i[0];Et[n]||(r[n]=t[n])}),r.isOldGNUFormat=t.ustar==Ot.OLDGNU_MAGIC,e&&(r.data=e),r}function zt(t,e){e=Ne.extend({},Tt,e);for(var r=[],i=0,n=t.length;n-i>=x.recordSize;){t=Ne.toUint8Array(t);var o=kt(t,i,e);if(!o)break;i+=xt(o);var s=It(t,i,o,e);if(r.push(Mt(o,s)),i+=vt(o.size),Dt(t,i))break}return r}qe.exports.untar=zt});var $e=L((pr,Xe)=>{"use strict";m();var _t=Y(),Ct=X(),Ut=We(),Rt=Ye();_t.extend(Xe.exports,Ut,Rt,Ct)});async function pe(t,e,r="auto"){let i=Lt(t,G),[n,o]=await jt(i,r),s=(e||"pgdata")+(o?".tar.gz":".tar"),a=o?"application/x-gzip":"application/x-tar";return typeof File<"u"?new File([n],s,{type:a}):new Blob([n],{type:a})}function Ht(t,e){let r=[],i=n=>{t.readdir(n).forEach(s=>{if(s==="."||s==="..")return;let a=n+"/"+s,c=t.stat(a),l=t.isFile(c.mode)?t.readFile(a,{encoding:"binary"}):new Uint8Array(0);r.push({name:a.substring(e.length),mode:c.mode,size:c.size,type:t.isFile(c.mode)?U.REGTYPE:U.DIRTYPE,modifyTime:c.mtime,data:l}),t.isDir(c.mode)&&i(a)})};return i(e),r}function Lt(t,e){let r=Ht(t,e);return(0,U.tar)(r)}async function jt(t,e="auto"){if(e==="none")return[t,!1];if(typeof CompressionStream<"u")return[await Bt(t),!0];if(typeof process<"u"&&process.versions&&process.versions.node)return[await Gt(t),!0];if(e==="auto")return[t,!1];throw new Error("Compression not supported in this environment")}async function Bt(t){let e=new CompressionStream("gzip"),r=e.writable.getWriter(),i=e.readable.getReader();r.write(t),r.close();let n=[];for(;;){let{value:a,done:c}=await i.read();if(c)break;a&&n.push(a)}let o=new Uint8Array(n.reduce((a,c)=>a+c.length,0)),s=0;return n.forEach(a=>{o.set(a,s),s+=a.length}),o}async function Gt(t){let{promisify:e}=await import("util"),{gzip:r}=await import("zlib");return await e(r)(t)}var U,de=E(()=>{"use strict";m();U=fe($e(),1);le()});var Je=E(()=>{"use strict";m();ne();le();de()});var Ke=E(()=>{"use strict";m();ne();de()});var Wt,G,le=E(()=>{"use strict";m();Je();Ke();Wt="/tmp/pglite",G=Wt+"/base"});var ue,f,Ae=E(()=>{"use strict";m();ue={EBADF:8,EBADFD:127,EEXIST:20,EINVAL:28,EISDIR:31,ENODEV:43,ENOENT:44,ENOTDIR:54,ENOTEMPTY:55},f=class extends Error{constructor(e,r){super(r),typeof e=="number"?this.code=e:typeof e=="string"&&(this.code=ue[e])}}});function h(...t){}var Ve,Ze=E(()=>{"use strict";m();Ae();Ve=(t,e)=>{let r=t.FS,i={tryFSOperation(n){try{return n()}catch(o){throw o.code?o.code==="UNKNOWN"?new r.ErrnoError(ue.EINVAL):new r.ErrnoError(o.code):o}},mount(n){return i.createNode(null,"/",16895,0)},syncfs(n,o,s){},createNode(n,o,s,a){if(!r.isDir(s)&&!r.isFile(s))throw new r.ErrnoError(28);let c=r.createNode(n,o,s);return c.node_ops=i.node_ops,c.stream_ops=i.stream_ops,c},getMode:function(n){return h("getMode",n),i.tryFSOperation(()=>e.lstat(n).mode)},realPath:function(n){let o=[];for(;n.parent!==n;)o.push(n.name),n=n.parent;return o.push(n.mount.opts.root),o.reverse(),o.join("/")},node_ops:{getattr(n){h("getattr",i.realPath(n));let o=i.realPath(n);return i.tryFSOperation(()=>{let s=e.lstat(o);return{...s,dev:0,ino:n.id,nlink:1,rdev:n.rdev,atime:new Date(s.atime),mtime:new Date(s.mtime),ctime:new Date(s.ctime)}})},setattr(n,o){h("setattr",i.realPath(n),o);let s=i.realPath(n);i.tryFSOperation(()=>{o.mode!==void 0&&e.chmod(s,o.mode),o.size!==void 0&&e.truncate(s,o.size),o.timestamp!==void 0&&e.utimes(s,o.timestamp,o.timestamp),o.size!==void 0&&e.truncate(s,o.size)})},lookup(n,o){h("lookup",i.realPath(n),o);let s=[i.realPath(n),o].join("/"),a=i.getMode(s);return i.createNode(n,o,a)},mknod(n,o,s,a){h("mknod",i.realPath(n),o,s,a);let c=i.createNode(n,o,s,a),l=i.realPath(c);return i.tryFSOperation(()=>(r.isDir(c.mode)?e.mkdir(l,{mode:s}):e.writeFile(l,"",{mode:s}),c))},rename(n,o,s){h("rename",i.realPath(n),i.realPath(o),s);let a=i.realPath(n),c=[i.realPath(o),s].join("/");i.tryFSOperation(()=>{e.rename(a,c)}),n.name=s},unlink(n,o){h("unlink",i.realPath(n),o);let s=[i.realPath(n),o].join("/");try{e.unlink(s)}catch{}},rmdir(n,o){h("rmdir",i.realPath(n),o);let s=[i.realPath(n),o].join("/");return i.tryFSOperation(()=>{e.rmdir(s)})},readdir(n){h("readdir",i.realPath(n));let o=i.realPath(n);return i.tryFSOperation(()=>e.readdir(o))},symlink(n,o,s){throw h("symlink",i.realPath(n),o,s),new r.ErrnoError(63)},readlink(n){throw h("readlink",i.realPath(n)),new r.ErrnoError(63)}},stream_ops:{open(n){h("open stream",i.realPath(n.node));let o=i.realPath(n.node);return i.tryFSOperation(()=>{r.isFile(n.node.mode)&&(n.shared.refcount=1,n.nfd=e.open(o))})},close(n){return h("close stream",i.realPath(n.node)),i.tryFSOperation(()=>{r.isFile(n.node.mode)&&n.nfd&&--n.shared.refcount===0&&e.close(n.nfd)})},dup(n){h("dup stream",i.realPath(n.node)),n.shared.refcount++},read(n,o,s,a,c){return h("read stream",i.realPath(n.node),s,a,c),a===0?0:i.tryFSOperation(()=>e.read(n.nfd,o,s,a,c))},write(n,o,s,a,c){return h("write stream",i.realPath(n.node),s,a,c),i.tryFSOperation(()=>e.write(n.nfd,o.buffer,s,a,c))},llseek(n,o,s){h("llseek stream",i.realPath(n.node),o,s);let a=o;if(s===1?a+=n.position:s===2&&r.isFile(n.node.mode)&&i.tryFSOperation(()=>{let c=e.fstat(n.nfd);a+=c.size}),a<0)throw new r.ErrnoError(28);return a},mmap(n,o,s,a,c){if(h("mmap stream",i.realPath(n.node),o,s,a,c),!r.isFile(n.node.mode))throw new r.ErrnoError(ue.ENODEV);let l=t.mmapAlloc(o);return i.stream_ops.read(n,t.HEAP8,l,o,s),{ptr:l,allocated:!0}},msync(n,o,s,a,c){return h("msync stream",i.realPath(n.node),s,a,c),i.stream_ops.write(n,o,0,a,s),0}}};return i}});var qt,Yt,Oe,K,V,q,H,Z,w,I,P,Q,z,_,D,d,Qe,R,W,v,b,J,et,Te,Ee,me,tt=E(()=>{"use strict";m();Ae();qt="state.txt",Yt="data",Oe={DIR:16384,FILE:32768},Ee=class Ee{constructor({root:e,initialPoolSize:r,maintainedPoolSize:i}){g(this,d);g(this,K,!1);g(this,V);g(this,q);g(this,H);g(this,Z);g(this,w);g(this,I,new Map);g(this,P,new Map);g(this,Q,0);g(this,z,new Map);g(this,_,new Map);this.lastCheckpoint=0;this.checkpointInterval=1e3*60;this.poolCounter=0;g(this,D,new Set);this.root=e,this.initialPoolSize=r||1e3,this.maintainedPoolSize=i||100,this.readyPromise=u(this,d,Qe).call(this)}static async create(e){let r=new Ee(e);return await r.readyPromise,r}get ready(){return p(this,K)}async maintainPool(e){e=e||this.maintainedPoolSize;let r=e-this.state.pool.length,i=[];for(let n=0;n<r;n++)i.push(new Promise(async o=>{++this.poolCounter;let s=`${(Date.now()-1704063600).toString(16).padStart(8,"0")}-${this.poolCounter.toString(16).padStart(8,"0")}`,a=await p(this,H).getFileHandle(s,{create:!0}),c=await a.createSyncAccessHandle();p(this,I).set(s,a),p(this,P).set(s,c),u(this,d,W).call(this,{opp:"createPoolFile",args:[s]}),this.state.pool.push(s),o()}));for(let n=0;n>r;n--)i.push(new Promise(async o=>{let s=this.state.pool.pop();u(this,d,W).call(this,{opp:"deletePoolFile",args:[s]});let a=p(this,I).get(s);p(this,P).get(s)?.close(),await a.remove().then(()=>{p(this,I).delete(s),p(this,P).delete(s),o()})}));await Promise.all(i)}_createPoolFileState(e){this.state.pool.push(e)}_deletePoolFileState(e){let r=this.state.pool.indexOf(e);r>-1&&this.state.pool.splice(r,1)}async maybeCheckpointState(){Date.now()-this.lastCheckpoint>this.checkpointInterval&&await this.checkpointState()}async checkpointState(){let e=new TextEncoder().encode(JSON.stringify(this.state));p(this,w).truncate(0),p(this,w).write(e,{at:0}),p(this,w).flush(),this.lastCheckpoint=Date.now()}flush(){for(let e of p(this,D))try{e.flush()}catch{}p(this,D).clear()}exit(){for(let e of p(this,P).values())e.close();p(this,w).flush(),p(this,w).close()}chmod(e,r){u(this,d,R).call(this,{opp:"chmod",args:[e,r]},()=>{this._chmodState(e,r)})}_chmodState(e,r){let i=u(this,d,b).call(this,e);i.mode=r}close(e){let r=u(this,d,J).call(this,e);p(this,z).delete(e),p(this,_).delete(r)}fstat(e){let r=u(this,d,J).call(this,e);return this.lstat(r)}lstat(e){let r=u(this,d,b).call(this,e),i=r.type==="file"?p(this,P).get(r.backingFilename).getSize():0,n=4096;return{dev:0,ino:0,mode:r.mode,nlink:1,uid:0,gid:0,rdev:0,size:i,blksize:n,blocks:Math.ceil(i/n),atime:r.lastModified,mtime:r.lastModified,ctime:r.lastModified}}mkdir(e,r){u(this,d,R).call(this,{opp:"mkdir",args:[e,r]},()=>{this._mkdirState(e,r)})}_mkdirState(e,r){let i=u(this,d,v).call(this,e),n=i.pop(),o=[],s=this.state.root;for(let c of i){if(o.push(e),!Object.prototype.hasOwnProperty.call(s.children,c))if(r?.recursive)this.mkdir(o.join("/"));else throw new f("ENOENT","No such file or directory");if(s.children[c].type!=="directory")throw new f("ENOTDIR","Not a directory");s=s.children[c]}if(Object.prototype.hasOwnProperty.call(s.children,n))throw new f("EEXIST","File exists");let a={type:"directory",lastModified:Date.now(),mode:r?.mode||Oe.DIR,children:{}};s.children[n]=a}open(e,r,i){if(u(this,d,b).call(this,e).type!=="file")throw new f("EISDIR","Is a directory");let o=u(this,d,et).call(this);return p(this,z).set(o,e),p(this,_).set(e,o),o}readdir(e){let r=u(this,d,b).call(this,e);if(r.type!=="directory")throw new f("ENOTDIR","Not a directory");return Object.keys(r.children)}read(e,r,i,n,o){let s=u(this,d,J).call(this,e),a=u(this,d,b).call(this,s);if(a.type!=="file")throw new f("EISDIR","Is a directory");return p(this,P).get(a.backingFilename).read(new Int8Array(r.buffer,i,n),{at:o})}rename(e,r){u(this,d,R).call(this,{opp:"rename",args:[e,r]},()=>{this._renameState(e,r,!0)})}_renameState(e,r,i=!1){let n=u(this,d,v).call(this,e),o=n.pop(),s=u(this,d,b).call(this,n.join("/"));if(!Object.prototype.hasOwnProperty.call(s.children,o))throw new f("ENOENT","No such file or directory");let a=u(this,d,v).call(this,r),c=a.pop(),l=u(this,d,b).call(this,a.join("/"));if(i&&Object.prototype.hasOwnProperty.call(l.children,c)){let y=l.children[c];p(this,P).get(y.backingFilename).truncate(0),this.state.pool.push(y.backingFilename)}l.children[c]=s.children[o],delete s.children[o]}rmdir(e){u(this,d,R).call(this,{opp:"rmdir",args:[e]},()=>{this._rmdirState(e)})}_rmdirState(e){let r=u(this,d,v).call(this,e),i=r.pop(),n=u(this,d,b).call(this,r.join("/"));if(!Object.prototype.hasOwnProperty.call(n.children,i))throw new f("ENOENT","No such file or directory");let o=n.children[i];if(o.type!=="directory")throw new f("ENOTDIR","Not a directory");if(Object.keys(o.children).length>0)throw new f("ENOTEMPTY","Directory not empty");delete n.children[i]}truncate(e,r=0){let i=u(this,d,b).call(this,e);if(i.type!=="file")throw new f("EISDIR","Is a directory");let n=p(this,P).get(i.backingFilename);if(!n)throw new f("ENOENT","No such file or directory");n.truncate(r),p(this,D).add(n)}unlink(e){u(this,d,R).call(this,{opp:"unlink",args:[e]},()=>{this._unlinkState(e,!0)})}_unlinkState(e,r=!1){let i=u(this,d,v).call(this,e),n=i.pop(),o=u(this,d,b).call(this,i.join("/"));if(!Object.prototype.hasOwnProperty.call(o.children,n))throw new f("ENOENT","No such file or directory");let s=o.children[n];if(s.type!=="file")throw new f("EISDIR","Is a directory");if(delete o.children[n],r){let a=p(this,P).get(s.backingFilename);a?.truncate(0),p(this,D).add(a),p(this,_).has(e)&&(p(this,z).delete(p(this,_).get(e)),p(this,_).delete(e))}this.state.pool.push(s.backingFilename)}utimes(e,r,i){u(this,d,R).call(this,{opp:"utimes",args:[e,r,i]},()=>{this._utimesState(e,r,i)})}_utimesState(e,r,i){let n=u(this,d,b).call(this,e);n.lastModified=i}writeFile(e,r,i){let n=u(this,d,v).call(this,e),o=n.pop(),s=u(this,d,b).call(this,n.join("/"));if(Object.prototype.hasOwnProperty.call(s.children,o)){let l=s.children[o];l.lastModified=Date.now(),u(this,d,W).call(this,{opp:"setLastModified",args:[e,l.lastModified]})}else{if(this.state.pool.length===0)throw new Error("No more file handles available in the pool");let l={type:"file",lastModified:Date.now(),mode:i?.mode||Oe.FILE,backingFilename:this.state.pool.pop()};s.children[o]=l,u(this,d,W).call(this,{opp:"createFileNode",args:[e,l]})}let a=s.children[o],c=p(this,P).get(a.backingFilename);r.length>0&&(c.write(typeof r=="string"?new TextEncoder().encode(r):new Int8Array(r),{at:0}),e.startsWith("/pg_wal")&&p(this,D).add(c))}_createFileNodeState(e,r){let i=u(this,d,v).call(this,e),n=i.pop(),o=u(this,d,b).call(this,i.join("/"));o.children[n]=r;let s=this.state.pool.indexOf(r.backingFilename);return s>-1&&this.state.pool.splice(s,1),r}_setLastModifiedState(e,r){let i=u(this,d,b).call(this,e);i.lastModified=r}write(e,r,i,n,o){let s=u(this,d,J).call(this,e),a=u(this,d,b).call(this,s);if(a.type!=="file")throw new f("EISDIR","Is a directory");let c=p(this,P).get(a.backingFilename);if(!c)throw new f("EBADF","Bad file descriptor");let l=c.write(new Int8Array(r,i,n),{at:o});return s.startsWith("/pg_wal")&&p(this,D).add(c),l}};K=new WeakMap,V=new WeakMap,q=new WeakMap,H=new WeakMap,Z=new WeakMap,w=new WeakMap,I=new WeakMap,P=new WeakMap,Q=new WeakMap,z=new WeakMap,_=new WeakMap,D=new WeakMap,d=new WeakSet,Qe=async function(){T(this,V,await navigator.storage.getDirectory()),T(this,q,await u(this,d,Te).call(this,this.root,{create:!0})),T(this,H,await u(this,d,Te).call(this,Yt,{from:p(this,q),create:!0})),T(this,Z,await p(this,q).getFileHandle(qt,{create:!0})),T(this,w,await p(this,Z).createSyncAccessHandle());let e=new ArrayBuffer(p(this,w).getSize());p(this,w).read(e,{at:0});let r,i=new TextDecoder().decode(e).split(`
`),n=!1;try{r=JSON.parse(i[0])}catch{r={root:{type:"directory",lastModified:Date.now(),mode:Oe.DIR,children:{}},pool:[]},p(this,w).truncate(0),p(this,w).write(new TextEncoder().encode(JSON.stringify(r)),{at:0}),n=!0}this.state=r;let o=i.slice(1).filter(Boolean).map(l=>JSON.parse(l));for(let l of o){let y=`_${l.opp}State`;if(typeof this[y]=="function")try{this[y].bind(this)(...l.args)}catch(S){console.warn("Error applying OPFS AHP WAL entry",l,S)}}let s=[],a=async l=>{if(l.type==="file")try{let y=await p(this,H).getFileHandle(l.backingFilename),S=await y.createSyncAccessHandle();p(this,I).set(l.backingFilename,y),p(this,P).set(l.backingFilename,S)}catch(y){console.error("Error opening file handle for node",l,y)}else for(let y of Object.values(l.children))s.push(a(y))};await a(this.state.root);let c=[];for(let l of this.state.pool)c.push(new Promise(async y=>{p(this,I).has(l)&&console.warn("File handle already exists for pool file",l);let S=await p(this,H).getFileHandle(l),rt=await S.createSyncAccessHandle();p(this,I).set(l,S),p(this,P).set(l,rt),y()}));await Promise.all([...s,...c]),await this.maintainPool(n?this.initialPoolSize:this.maintainedPoolSize),T(this,K,!0)},R=function(e,r){let i=u(this,d,W).call(this,e);try{r()}catch(n){throw p(this,w).truncate(i),n}},W=function(e){let r=JSON.stringify(e),i=new TextEncoder().encode(`
${r}`),n=p(this,w).getSize();return p(this,w).write(i,{at:n}),p(this,D).add(p(this,w)),n},v=function(e){return e.split("/").filter(Boolean)},b=function(e,r){let i=u(this,d,v).call(this,e),n=r||this.state.root;for(let o of i){if(n.type!=="directory")throw new f("ENOTDIR","Not a directory");if(!Object.prototype.hasOwnProperty.call(n.children,o))throw new f("ENOENT","No such file or directory");n=n.children[o]}return n},J=function(e){let r=p(this,z).get(e);if(!r)throw new f("EBADF","Bad file descriptor");return r},et=function(){let e=++ye(this,Q)._;for(;p(this,z).has(e);)ye(this,Q)._++;return e},Te=async function(e,r){let i=u(this,d,v).call(this,e),n=r?.from||p(this,V);for(let o of i)n=await n.getDirectoryHandle(o,{create:r?.create});return n};me=Ee});var Xt={};ct(Xt,{OpfsAhpFS:()=>xe});module.exports=pt(Xt);var ee,te,xe,$t=E(()=>{m();ne();le();Ze();tt();de();xe=class extends j{constructor(r,{initialPoolSize:i,maintainedPoolSize:n}={}){super(r);g(this,ee);g(this,te);T(this,ee,i??1e3),T(this,te,n??100)}async emscriptenOpts(r){return this.opfsAhp=await me.create({root:this.dataDir,initialPoolSize:p(this,ee),maintainedPoolSize:p(this,te)}),{...r,preRun:[...r.preRun||[],n=>{let o=Ve(n,this.opfsAhp);n.FS.mkdir(G),n.FS.mount(o,{},G)}]}}async syncToFs(r,i=!1){await this.opfsAhp?.maybeCheckpointState(),await this.opfsAhp?.maintainPool(),i||this.opfsAhp?.flush()}async dumpTar(r,i,n){return pe(r,i,n)}async close(r){this.opfsAhp?.exit(),r.quit()}};ee=new WeakMap,te=new WeakMap});$t();0&&(module.exports={OpfsAhpFS});
//# sourceMappingURL=index.cjs.map